nextflow_pipeline {

    name "RNA editing production data compatibility testing"
    script "../main.nf"
    tag "production"
    tag "compatibility"
    tag "rna_editing"
    tag "downstream_tools"

    test("Production compatibility - VCF format validation") {

        when {
            params {
                input                    = "${projectDir}/tests/csv/3.0/fastq_pair.csv"
                outdir                   = "$outputDir"
                genome                   = null
                igenomes_ignore          = true
                fasta                    = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta"
                fasta_fai                = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta.fai"
                dict                     = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.dict"
                tools                    = "rescue"
                enable_rna_annotation    = true
                rediportal_vcf           = "${projectDir}/tests/data/test_rediportal.vcf.gz"
                rediportal_tbi           = "${projectDir}/tests/data/test_rediportal.vcf.gz.tbi"
                min_rna_support          = 2
                skip_tools               = "baserecalibrator,markduplicates"
                max_cpus                 = 2
                max_memory               = "6.GB"
                max_time                 = "6.h"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                
                // Validate VCF format compliance
                {
                    def vcfFiles = file("$outputDir").listFiles().findAll { 
                        it.name.endsWith('.vcf.gz') && it.name.contains('rescue')
                    }
                    
                    assert vcfFiles.size() > 0
                    
                    // Each VCF file should be properly formatted
                    vcfFiles.each { vcfFile ->
                        assert vcfFile.exists()
                        assert vcfFile.size() > 0
                        
                        // Should have corresponding index
                        def indexFile = new File(vcfFile.path + ".tbi")
                        // Index file existence depends on workflow completion
                    }
                },
                
                // Validate that standard VCF tools can process the output
                {
                    // The fact that VCF_RESCUE_FILTERING completed successfully
                    // indicates that bcftools and other standard tools can process the VCF
                    assert workflow.trace.tasks().any { it.name.contains('VCF_RESCUE_FILTERING') }
                    assert !workflow.trace.failed().any { it.name.contains('VCF_RESCUE_FILTERING') }
                }
            )
        }
    }

    test("Production compatibility - annotation field preservation") {

        when {
            params {
                input                    = "${projectDir}/tests/csv/3.0/fastq_pair.csv"
                outdir                   = "$outputDir"
                genome                   = null
                igenomes_ignore          = true
                fasta                    = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta"
                fasta_fai                = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta.fai"
                dict                     = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.dict"
                tools                    = "rescue"
                enable_rna_annotation    = true
                rediportal_vcf           = "${projectDir}/tests/data/test_rediportal.vcf.gz"
                rediportal_tbi           = "${projectDir}/tests/data/test_rediportal.vcf.gz.tbi"
                min_rna_support          = 2
                skip_tools               = "baserecalibrator,markduplicates"
                max_cpus                 = 2
                max_memory               = "6.GB"
                max_time                 = "6.h"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                
                // Verify RNA editing annotation was applied
                { assert workflow.trace.tasks().any { it.name.contains('RNA_EDITING_ANNOTATION') } },
                
                // Verify filtering preserved annotations
                { assert workflow.trace.tasks().any { it.name.contains('VCF_RESCUE_FILTERING') } },
                
                // Workflow completion indicates annotation preservation worked
                { assert workflow.trace.succeeded().size() > 0 },
                
                // No failures in filtering step indicates annotations were preserved
                { assert !workflow.trace.failed().any { it.name.contains('VCF_RESCUE_FILTERING') } }
            )
        }
    }

    test("Production compatibility - large dataset simulation") {

        when {
            params {
                input                    = "${projectDir}/tests/csv/3.0/fastq_pair.csv"
                outdir                   = "$outputDir"
                genome                   = null
                igenomes_ignore          = true
                fasta                    = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta"
                fasta_fai                = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta.fai"
                dict                     = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.dict"
                tools                    = "rescue"
                enable_rna_annotation    = true
                rediportal_vcf           = "${projectDir}/tests/data/test_rediportal.vcf.gz"
                rediportal_tbi           = "${projectDir}/tests/data/test_rediportal.vcf.gz.tbi"
                min_rna_support          = 2
                skip_tools               = "baserecalibrator,markduplicates"
                // Simulate production resource requirements
                max_cpus                 = 4
                max_memory               = "16.GB"
                max_time                 = "8.h"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                
                // Verify scalability with higher resource allocation
                {
                    def rnaAnnotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    rnaAnnotationTasks.each { task ->
                        def peakRss = task.get('peak_rss')
                        def cpus = task.get('cpus')
                        def realtime = task.get('realtime')
                        
                        // Should utilize available resources efficiently
                        if (cpus != null) {
                            assert cpus <= 4
                        }
                        
                        // Should handle larger memory allocation
                        if (peakRss != null) {
                            assert peakRss < 16000000000L  // 16GB limit
                        }
                        
                        // Should complete in reasonable time
                        if (realtime != null) {
                            assert realtime < 7200000  // 2 hours max for test data
                        }
                    }
                },
                
                { assert path("$outputDir").exists() }
            )
        }
    }

    test("Production compatibility - multi-sample processing") {

        when {
            params {
                input                    = "${projectDir}/tests/csv/3.0/fastq_pair.csv"
                outdir                   = "$outputDir"
                genome                   = null
                igenomes_ignore          = true
                fasta                    = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta"
                fasta_fai                = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta.fai"
                dict                     = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.dict"
                tools                    = "rescue"
                enable_rna_annotation    = true
                rediportal_vcf           = "${projectDir}/tests/data/test_rediportal.vcf.gz"
                rediportal_tbi           = "${projectDir}/tests/data/test_rediportal.vcf.gz.tbi"
                min_rna_support          = 2
                skip_tools               = "baserecalibrator,markduplicates"
                max_cpus                 = 2
                max_memory               = "6.GB"
                max_time                 = "6.h"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                
                // Verify parallel processing capability
                {
                    def rnaAnnotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    // Should have at least one RNA annotation task per sample
                    assert rnaAnnotationTasks.size() >= 1
                },
                
                // Verify all samples processed successfully
                { assert workflow.trace.succeeded().size() > 0 },
                { assert workflow.trace.failed().size() == 0 },
                
                // Verify output structure for multiple samples
                { assert path("$outputDir").exists() },
                { assert path("$outputDir/variant_calling").exists() }
            )
        }
    }

    test("Production compatibility - workflow reporting and monitoring") {

        when {
            params {
                input                    = "${projectDir}/tests/csv/3.0/fastq_pair.csv"
                outdir                   = "$outputDir"
                genome                   = null
                igenomes_ignore          = true
                fasta                    = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta"
                fasta_fai                = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta.fai"
                dict                     = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.dict"
                tools                    = "rescue"
                enable_rna_annotation    = true
                rediportal_vcf           = "${projectDir}/tests/data/test_rediportal.vcf.gz"
                rediportal_tbi           = "${projectDir}/tests/data/test_rediportal.vcf.gz.tbi"
                min_rna_support          = 2
                skip_tools               = "baserecalibrator,markduplicates"
                max_cpus                 = 2
                max_memory               = "6.GB"
                max_time                 = "6.h"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                
                // Verify pipeline info and reporting
                { assert path("$outputDir/pipeline_info").exists() },
                
                // Verify version tracking includes RNA editing components
                { 
                    def versionFile = path("$outputDir/pipeline_info/nf_core_rnadnavar_software_mqc_versions.yml")
                    assert versionFile.exists()
                },
                
                // Verify execution report generation
                {
                    def pipelineInfoFiles = file("$outputDir/pipeline_info").listFiles()
                    assert pipelineInfoFiles.size() > 0
                },
                
                // Verify RNA editing tasks are tracked in execution
                {
                    def rnaAnnotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    rnaAnnotationTasks.each { task ->
                        // Should have execution metadata
                        assert task.get('name') != null
                        assert task.get('status') != null
                        assert task.get('exit') != null
                    }
                }
            )
        }
    }

    test("Production compatibility - configuration profiles") {

        when {
            params {
                input                    = "${projectDir}/tests/csv/3.0/fastq_pair.csv"
                outdir                   = "$outputDir"
                genome                   = null
                igenomes_ignore          = true
                fasta                    = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta"
                fasta_fai                = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.fasta.fai"
                dict                     = "https://raw.githubusercontent.com/nf-core/test-datasets/modules/data/genomics/homo_sapiens/genome/genome.dict"
                tools                    = "rescue"
                enable_rna_annotation    = true
                rediportal_vcf           = "${projectDir}/tests/data/test_rediportal.vcf.gz"
                rediportal_tbi           = "${projectDir}/tests/data/test_rediportal.vcf.gz.tbi"
                min_rna_support          = 2
                skip_tools               = "baserecalibrator,markduplicates"
                max_cpus                 = 2
                max_memory               = "6.GB"
                max_time                 = "6.h"
            }
        }

        then {
            assertAll(
                // Should work with standard configuration
                { assert workflow.success },
                
                // Should respect parameter configuration
                {
                    def rnaAnnotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    assert rnaAnnotationTasks.any { task ->
                        task.script.contains('--min-rna-support 2')
                    }
                },
                
                // Should integrate with existing workflow profiles
                { assert workflow.trace.succeeded().size() > 0 },
                
                { assert path("$outputDir").exists() }
            )
        }
    }
}