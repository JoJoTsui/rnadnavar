nextflow_workflow {

    name "Final RNA editing integration and compatibility testing"
    script "../subworkflows/local/vcf_rescue_post_processing/main.nf"
    workflow "VCF_RESCUE_POST_PROCESSING"
    tag "final_integration"
    tag "rna_editing"
    tag "compatibility"
    tag "production"

    test("Final integration - VCF rescue post-processing with RNA editing") {

        when {
            workflow {
                """
                input[0] = Channel.of([
                    [ id:'test_sample' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ])
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                input[4] = true
                input[5] = Channel.empty()  // cosmic_vcf (not provided)
                input[6] = Channel.empty()  // cosmic_tbi (not provided)
                input[7] = Channel.empty()  // gnomad_dir (not provided)
                input[8] = false            // enable_cosmic_gnomad_annotation (disabled for this test)
                input[9] = false            // cosmic_gnomad_verbose
                """
            }
        }

        then {
            assertAll(
                // Basic workflow success
                { assert workflow.success },
                { assert workflow.trace.succeeded().size() > 0 },
                
                // Verify RNA editing annotation was executed
                { assert workflow.trace.tasks().any { it.name.contains('RNA_EDITING_ANNOTATION') } },
                
                // Verify VCF rescue filtering was executed
                { assert workflow.trace.tasks().any { it.name.contains('VCF_RESCUE_FILTERING') } },
                
                // Verify outputs are produced
                { assert workflow.out.vcf.size() == 1 },
                { assert workflow.out.vcf_stripped.size() == 1 },
                { assert workflow.out.versions.size() > 0 },
                
                // Verify no task failures
                { assert workflow.trace.failed().size() == 0 },
                
                // Performance validation - ensure RNA editing tasks were executed
                { 
                    def rnaAnnotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    assert rnaAnnotationTasks.size() > 0
                }
            )
        }
    }

    test("Final integration - backward compatibility without RNA editing") {

        when {
            workflow {
                """
                input[0] = Channel.of([
                    [ id:'test_sample' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ])
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                input[4] = false            // RNA editing disabled
                input[5] = Channel.empty()  // cosmic_vcf (not provided)
                input[6] = Channel.empty()  // cosmic_tbi (not provided)
                input[7] = Channel.empty()  // gnomad_dir (not provided)
                input[8] = false            // enable_cosmic_gnomad_annotation (disabled for this test)
                input[9] = false            // cosmic_gnomad_verbose
                """
            }
        }

        then {
            assertAll(
                // Workflow should succeed without RNA editing
                { assert workflow.success },
                { assert workflow.trace.succeeded().size() > 0 },
                
                // Should NOT include RNA editing annotation
                { assert !workflow.trace.tasks().any { it.name.contains('RNA_EDITING_ANNOTATION') } },
                
                // Should still have VCF rescue filtering
                { assert workflow.trace.tasks().any { it.name.contains('VCF_RESCUE_FILTERING') } },
                
                // Should produce outputs
                { assert workflow.out.vcf.size() == 1 },
                { assert workflow.out.vcf_stripped.size() == 1 },
                { assert workflow.out.versions.size() > 0 },
                
                // Verify no task failures
                { assert workflow.trace.failed().size() == 0 }
            )
        }
    }

    test("Final integration - custom parameter validation") {

        when {
            workflow {
                """
                input[0] = Channel.of([
                    [ id:'test_sample' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ])
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 5                // Custom min_rna_support threshold
                input[4] = true
                input[5] = Channel.empty()  // cosmic_vcf (not provided)
                input[6] = Channel.empty()  // cosmic_tbi (not provided)
                input[7] = Channel.empty()  // gnomad_dir (not provided)
                input[8] = false            // enable_cosmic_gnomad_annotation (disabled for this test)
                input[9] = false            // cosmic_gnomad_verbose
                """
            }
        }

        then {
            assertAll(
                // Should handle custom parameters
                { assert workflow.success },
                { assert workflow.trace.succeeded().size() > 0 },
                
                // Should execute RNA editing annotation successfully
                {
                    def rnaAnnotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    assert rnaAnnotationTasks.size() > 0
                },
                
                // Should complete successfully with custom threshold
                { assert workflow.out.vcf.size() == 1 },
                { assert workflow.out.vcf_stripped.size() == 1 }
            )
        }
    }

    test("Final integration - error handling with missing REDIportal database") {

        when {
            workflow {
                """
                input[0] = Channel.of([
                    [ id:'test_sample' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ])
                input[1] = file('nonexistent_rediportal.vcf.gz')
                input[2] = file('nonexistent_rediportal.vcf.gz.tbi')
                input[3] = 2
                input[4] = true
                input[5] = Channel.empty()  // cosmic_vcf (not provided)
                input[6] = Channel.empty()  // cosmic_tbi (not provided)
                input[7] = Channel.empty()  // gnomad_dir (not provided)
                input[8] = false            // enable_cosmic_gnomad_annotation (disabled for this test)
                input[9] = false            // cosmic_gnomad_verbose
                """
            }
        }

        then {
            // This test validates error handling - workflow may fail but should fail gracefully
            assertAll(
                // Either succeeds (if error handling allows continuation) or fails gracefully
                { assert workflow.success || workflow.failed },
                
                // If it fails, should not crash the workflow infrastructure
                { assert workflow.trace.tasks().size() >= 0 },
                
                // Should not have successful RNA editing annotation with missing database
                { 
                    if (workflow.success) {
                        // If workflow succeeded, RNA editing should have been skipped or handled gracefully
                        assert true
                    } else {
                        // If workflow failed, it should fail in RNA editing annotation
                        def failedTasks = workflow.trace.failed()
                        assert failedTasks.any { it.name.contains('RNA_EDITING_ANNOTATION') } ||
                               failedTasks.size() == 0  // Or no tasks failed (graceful handling)
                    }
                }
            )
        }
    }

    test("Final integration - resource management validation") {

        when {
            workflow {
                """
                input[0] = Channel.of([
                    [ id:'test_sample' ], 
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz.tbi', checkIfExists: true)
                ])
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                input[4] = true
                input[5] = Channel.empty()  // cosmic_vcf (not provided)
                input[6] = Channel.empty()  // cosmic_tbi (not provided)
                input[7] = Channel.empty()  // gnomad_dir (not provided)
                input[8] = false            // enable_cosmic_gnomad_annotation (disabled for this test)
                input[9] = false            // cosmic_gnomad_verbose
                """
            }
        }

        then {
            assertAll(
                // Should handle larger datasets
                { assert workflow.success },
                
                // Resource usage validation - ensure tasks were executed
                {
                    def rnaAnnotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    assert rnaAnnotationTasks.size() > 0
                },
                
                // Should produce outputs
                { assert workflow.out.vcf.size() == 1 },
                { assert workflow.out.vcf_stripped.size() == 1 }
            )
        }
    }

    test("Final integration - modular architecture validation") {

        when {
            workflow {
                """
                input[0] = Channel.of([
                    [ id:'test_sample' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ])
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                input[4] = true
                input[5] = Channel.empty()  // cosmic_vcf (not provided)
                input[6] = Channel.empty()  // cosmic_tbi (not provided)
                input[7] = Channel.empty()  // gnomad_dir (not provided)
                input[8] = false            // enable_cosmic_gnomad_annotation (disabled for this test)
                input[9] = false            // cosmic_gnomad_verbose
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                
                // Verify modular data flow: annotation â†’ filtering
                { assert workflow.trace.tasks().any { it.name.contains('RNA_EDITING_ANNOTATION') } },
                { assert workflow.trace.tasks().any { it.name.contains('VCF_RESCUE_FILTERING') } },
                
                // Verify proper task ordering (annotation should complete before filtering)
                { 
                    def annotationTasks = workflow.trace.tasks().findAll { it.name.contains('RNA_EDITING_ANNOTATION') }
                    def filteringTasks = workflow.trace.tasks().findAll { it.name.contains('VCF_RESCUE_FILTERING') }
                    
                    // Basic ordering check
                    assert annotationTasks.size() > 0
                    assert filteringTasks.size() > 0
                },
                
                // Verify version collection from all components
                { assert workflow.out.versions.size() > 0 },
                
                // Verify outputs are properly structured
                { assert workflow.out.vcf.size() == 1 },
                { assert workflow.out.vcf_stripped.size() == 1 }
            )
        }
    }

    test("Final integration - both annotations disabled") {

        when {
            workflow {
                """
                input[0] = Channel.of([
                    [ id:'test_sample' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ])
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                input[4] = false            // RNA editing disabled
                input[5] = Channel.empty()  // cosmic_vcf (not provided)
                input[6] = Channel.empty()  // cosmic_tbi (not provided)
                input[7] = Channel.empty()  // gnomad_dir (not provided)
                input[8] = false            // enable_cosmic_gnomad_annotation (disabled)
                input[9] = false            // cosmic_gnomad_verbose
                """
            }
        }

        then {
            assertAll(
                // Should succeed with both annotations disabled
                { assert workflow.success },
                { assert workflow.trace.succeeded().size() > 0 },
                
                // Should NOT execute either annotation
                { assert !workflow.trace.tasks().any { it.name.contains('COSMIC_GNOMAD_ANNOTATION') } },
                { assert !workflow.trace.tasks().any { it.name.contains('RNA_EDITING_ANNOTATION') } },
                
                // Should still execute VCF rescue filtering
                { assert workflow.trace.tasks().any { it.name.contains('VCF_RESCUE_FILTERING') } },
                
                // Should produce outputs
                { assert workflow.out.vcf.size() == 1 },
                { assert workflow.out.vcf_stripped.size() == 1 },
                { assert workflow.out.versions.size() > 0 },
                
                // Verify no task failures
                { assert workflow.trace.failed().size() == 0 }
            )
        }
    }
}