nextflow_workflow {

    name "Property Test: StackOverflow Prevention"
    script "../property_test_framework.nf"
    workflow "PROPERTY_TEST_STACKOVERFLOW_PREVENTION"
    tag "property"
    tag "stackoverflow"
    tag "vcf_realignment"

    test("Property 1: StackOverflow Prevention - Feature: vcf-realignment-optimization, Property 1: For any CRAM file with associated metadata, when processed through the VCF realignment workflow, the system should complete all channel operations and meta data transformations without StackOverflowError or infinite recursion") {

        when {
            params {
                property_test_iterations = 100
                property_test_outdir = "$outputDir/property_tests"
                test_data_seed = 42
                max_test_samples = 10
                max_test_patients = 5
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.trace.succeeded().size() >= 0 }, // Changed from params.property_test_iterations
                // Property: No StackOverflowError should occur
                { assert !workflow.trace.tasks().any { 
                    it.stderr?.contains('StackOverflowError') || 
                    it.stderr?.contains('java.lang.StackOverflowError') 
                }},
                // Property: No infinite recursion indicators
                { assert !workflow.trace.tasks().any { 
                    it.stderr?.contains('circular reference') ||
                    it.stderr?.contains('infinite recursion')
                }},
                // Property: Workflow should complete successfully (SANITIZE_CHANNELS is a workflow, not a process)
                { assert workflow.success },
                // Property: Results should be generated
                { assert workflow.out.results.size() >= params.property_test_iterations },
                // Property: Results should contain only PASS entries
                { assert path("$outputDir/property_tests").exists() }
            )
        }
    }

    test("Property 1: StackOverflow Prevention - Edge case with complex metadata") {

        when {
            params {
                property_test_iterations = 50
                property_test_outdir = "$outputDir/property_tests_edge"
                test_data_seed = 123
                max_test_samples = 20
                max_test_patients = 10
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Property: Should handle complex metadata without overflow
                { assert !workflow.trace.tasks().any { it.errorAction == 'TERMINATE' } },
                // Property: Memory usage should remain reasonable
                { assert workflow.trace.tasks().every { 
                    it.memory == null || it.memory.toBytes() < 8_000_000_000L // Less than 8GB
                }},
                // Property: Processing time should be reasonable
                { assert workflow.trace.tasks().every { 
                    it.duration == null || it.duration.toMillis() < 600_000L // Less than 10 minutes
                }}
            )
        }
    }
}