nextflow_workflow {

    name "Property Test: File Path Validation"
    script "../property_test_framework.nf"
    workflow "PROPERTY_TEST_FILE_PATH_VALIDATION"
    tag "property"
    tag "file_validation"
    tag "vcf_realignment"

    test("Property 4: File Path Validation - Feature: vcf-realignment-optimization, Property 4: For any file path added to metadata, the system should verify file existence and accessibility before proceeding with processing") {

        when {
            params {
                property_test_iterations = 100
                property_test_outdir = "$outputDir/property_tests"
                test_data_seed = 42
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.trace.succeeded().size() >= 1 },
                // Property: File validation should complete
                { assert workflow.trace.tasks().any { it.name.contains('INPUT_VALIDATION') } },
                // Property: Only valid, accessible files should pass
                { assert !workflow.trace.tasks().any { 
                    it.stderr?.contains('FileNotFoundException') ||
                    it.stderr?.contains('AccessDeniedException')
                }},
                // Property: Validation results should be consistent
                { assert workflow.trace.succeeded().size() > 0 },
                // Property: Test files should be created
                { assert path("$outputDir/property_tests").exists() }
            )
        }
    }

    test("Property 4: File Path Validation - Invalid file paths") {

        when {
            params {
                property_test_iterations = 50
                property_test_outdir = "$outputDir/property_tests_invalid"
                test_data_seed = 321
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Property: Should handle invalid paths gracefully
                { assert !workflow.trace.tasks().any { it.errorAction == 'TERMINATE' } },
                // Property: Invalid files should be filtered out
                { assert workflow.trace.tasks().any { it.name.contains('INPUT_VALIDATION') } },
                // Property: No crashes on null or empty paths
                { assert !workflow.trace.tasks().any { 
                    it.stderr?.contains('NullPointerException') ||
                    it.stderr?.contains('IllegalArgumentException')
                }}
            )
        }
    }

    test("Property 4: File Path Validation - Mixed valid and invalid paths") {

        when {
            params {
                property_test_iterations = 80
                property_test_outdir = "$outputDir/property_tests_mixed"
                test_data_seed = 654
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Property: Should separate valid from invalid files
                { assert workflow.trace.succeeded().size() >= 1 },
                // Property: Valid files should pass through
                { assert workflow.trace.tasks().any { it.name.contains('INPUT_VALIDATION') } },
                // Property: Processing should continue with valid files only
                { assert !workflow.trace.tasks().any { it.status == 'FAILED' } }
            )
        }
    }
}