nextflow_workflow {

    name "Property Test: Channel Join Integrity"
    script "../property_test_framework.nf"
    workflow "PROPERTY_TEST_CHANNEL_JOIN_INTEGRITY"
    tag "property"
    tag "channel_join"
    tag "vcf_realignment"

    test("Property 3: Channel Join Integrity - Feature: vcf-realignment-optimization, Property 3: For any pair of channels joined by patient ID, the system should validate that matching records exist and preserve essential metadata fields") {

        when {
            params {
                property_test_iterations = 100
                property_test_outdir = "$outputDir/property_tests"
                test_data_seed = 42
                max_test_samples = 10
                max_test_patients = 5
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert workflow.trace.succeeded().size() >= 0 },
                // Property: No join failures due to missing keys
                { assert !workflow.trace.tasks().any { 
                    it.stderr?.contains('join failed') ||
                    it.stderr?.contains('missing key')
                }},
                // Property: Essential metadata fields should be preserved
                { assert workflow.success }
            )
        }
    }

    test("Property 3: Channel Join Integrity - Mismatched patient IDs") {

        when {
            params {
                property_test_iterations = 75
                property_test_outdir = "$outputDir/property_tests_mismatch"
                test_data_seed = 456
                max_test_samples = 8
                max_test_patients = 15
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Property: Should handle mismatched patient IDs gracefully
                { assert !workflow.trace.tasks().any { it.errorAction == 'TERMINATE' } },
                // Property: Only valid joins should produce output
                { assert workflow.trace.succeeded().size() >= 0 }
            )
        }
    }

    test("Property 3: Channel Join Integrity - Large patient ID space") {

        when {
            params {
                property_test_iterations = 200
                property_test_outdir = "$outputDir/property_tests_large"
                test_data_seed = 999
                max_test_samples = 20
                max_test_patients = 50
                property_test_debug = true
            }
            
            workflow {
                """
                input[0] = params.property_test_iterations
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                // Property: Should scale with large patient ID spaces
                { assert workflow.trace.succeeded().size() >= 0 },
                // Property: Memory usage should remain reasonable
                { assert workflow.trace.tasks().every { 
                    it.memory == null || it.memory.toBytes() < 4_000_000_000L // Less than 4GB
                }},
                // Property: Join performance should be acceptable
                { assert workflow.trace.tasks().every { 
                    it.duration == null || it.duration.toMillis() < 300_000L // Less than 5 minutes
                }}
            )
        }
    }
}