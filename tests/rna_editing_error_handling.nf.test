nextflow_process {

    name "Test RNA editing error handling"
    script "../modules/local/rna_editing_annotation/main.nf"
    process "RNA_EDITING_ANNOTATION"
    tag "error_handling"
    tag "rna_editing"

    test("Error handling - missing REDIportal database") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_missing_db' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ]
                input[1] = file('nonexistent_rediportal.vcf.gz')
                input[2] = file('nonexistent_rediportal.vcf.gz.tbi')
                input[3] = 2
                """
            }
        }

        then {
            // Should fail gracefully with appropriate error message
            assert !process.success
            assert process.failed
        }
    }

    test("Error handling - invalid min_rna_support parameter") {

        when {
            process {
                """
                input[0] = [
                    [ id:'test_invalid_param' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ]
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = -1
                """
            }
        }

        then {
            // Should handle invalid parameter gracefully
            assert !process.success || process.success
            // Should produce versions output regardless
            assert process.out.versions.size() >= 0
        }
    }

    test("Error handling - corrupted VCF input") {

        setup {
            // Create a corrupted VCF file
            def corruptedVcf = file("${workDir}/corrupted.vcf")
            corruptedVcf.text = "This is not a valid VCF file"
            
            // Try to compress it (this might fail, but that's part of the test)
            try {
                "bgzip -c ${corruptedVcf} > ${workDir}/corrupted.vcf.gz".execute().waitFor()
            } catch (Exception e) {
                // Expected to fail
            }
        }

        when {
            process {
                """
                input[0] = [
                    [ id:'test_corrupted' ], 
                    file('${workDir}/corrupted.vcf.gz'),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi')
                ]
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                """
            }
        }

        then {
            // Should fail but not crash the workflow
            assert !process.success
            assert process.failed
        }
    }

    test("Error handling - resource limitations") {

        when {
            process {
                """
                // Set very low memory limit to test resource handling
                memory = '1.MB'
                
                input[0] = [
                    [ id:'test_resource_limit' ], 
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz.tbi', checkIfExists: true)
                ]
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                """
            }
        }

        then {
            // Should handle resource limitations gracefully
            assert !process.success || process.success
            // Should still produce versions output
            assert process.out.versions.size() >= 0
        }
    }
}