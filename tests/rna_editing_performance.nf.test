nextflow_process {

    name "Test RNA editing performance"
    script "../modules/local/rna_editing_annotation/main.nf"
    process "RNA_EDITING_ANNOTATION"
    tag "performance"
    tag "rna_editing"

    test("Performance - small VCF baseline") {

        when {
            process {
                """
                input[0] = [
                    [ id:'perf_small' ], 
                    file('${projectDir}/tests/data/test_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi', checkIfExists: true)
                ]
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.vcf.size() == 1 },
                // Verify output files are generated
                { assert process.out.vcf.get(0) != null },
                // Verify basic functionality works
                { assert process.out.versions != null }
            )
        }
    }

    test("Performance - large VCF processing with optimization") {

        when {
            process {
                """
                input[0] = [
                    [ id:'perf_large' ], 
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz.tbi', checkIfExists: true)
                ]
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.vcf.size() == 1 },
                // Verify output files are generated
                { assert process.out.vcf.get(0) != null },
                // Verify versions are captured
                { assert process.out.versions != null },
                // Verify process completed successfully (basic performance validation)
                { assert process.success },
                // Verify output structure is correct
                { assert process.out.vcf.size() == 1 }
            )
        }
    }

    test("Performance - memory usage patterns and optimization") {

        when {
            process {
                """
                // Set specific memory allocation for monitoring
                memory = '4.GB'
                cpus = 2
                
                input[0] = [
                    [ id:'perf_memory' ], 
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz.tbi', checkIfExists: true)
                ]
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.vcf.size() == 1 },
                // Verify output is generated successfully
                { assert process.out.vcf.get(0) != null },
                // Verify versions are captured
                { assert process.out.versions != null },
                // Verify memory optimization is working (process completes successfully)
                { assert process.success }
            )
        }
    }

    test("Performance - production dataset validation") {

        when {
            process {
                """
                // Simulate production-size processing
                memory = '8.GB'
                cpus = 4
                time = '2.h'
                
                input[0] = [
                    [ id:'perf_production' ], 
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz', checkIfExists: true),
                    file('${projectDir}/tests/data/test_large_rescue.vcf.gz.tbi', checkIfExists: true)
                ]
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.vcf.size() == 1 },
                // Verify production-level processing works
                { assert process.out.vcf.get(0) != null },
                // Verify versions are captured for production datasets
                { assert process.out.versions != null },
                // Verify production-level performance (process completes successfully)
                { assert process.success }
            )
        }
    }

    test("Performance - scalability with multiple samples and parallel processing") {

        when {
            process {
                """
                input[0] = Channel.of(
                    [[ id:'sample1' ], file('${projectDir}/tests/data/test_rescue.vcf.gz'), file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi')],
                    [[ id:'sample2' ], file('${projectDir}/tests/data/test_large_rescue.vcf.gz'), file('${projectDir}/tests/data/test_large_rescue.vcf.gz.tbi')],
                    [[ id:'sample3' ], file('${projectDir}/tests/data/test_rescue.vcf.gz'), file('${projectDir}/tests/data/test_rescue.vcf.gz.tbi')],
                    [[ id:'sample4' ], file('${projectDir}/tests/data/test_large_rescue.vcf.gz'), file('${projectDir}/tests/data/test_large_rescue.vcf.gz.tbi')]
                )
                input[1] = file('${projectDir}/tests/data/test_rediportal.vcf.gz', checkIfExists: true)
                input[2] = file('${projectDir}/tests/data/test_rediportal.vcf.gz.tbi', checkIfExists: true)
                input[3] = 2
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.vcf.size() == 4 },
                // Verify all samples processed successfully
                { assert process.out.vcf.size() == 4 },
                // Verify all outputs are generated
                { assert process.out.vcf.every { it != null } },
                // Verify versions are captured for all samples
                { assert process.out.versions != null },
                // Verify parallel processing efficiency (all processes succeed)
                { assert process.success },
                // Verify scalability works (correct number of outputs)
                { assert process.out.vcf.size() == 4 }
            )
        }
    }
}