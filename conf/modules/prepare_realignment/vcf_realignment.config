/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for VCF Realignment Workflow - Comprehensive publishDir overrides
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    This config routes all realignment workflow outputs to vcf_realignment/ directory
    to keep them separate from main pipeline outputs.
    
    Pattern explanation:
    - Uses wildcard selectors: '.*:RNA_REALIGNMENT_WORKFLOW:.*:PROCESS_NAME'
    - This catches processes nested within RNA_REALIGNMENT_WORKFLOW regardless of parent scope
    - Loaded AFTER base modules.config to ensure overrides take precedence
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

process {

    // ============================================================================
    // GATK Preprocessing (already handled by optimization.config)
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:GATK4_MARKDUPLICATES' {
        publishDir = [
            [
                enabled: !params.save_output_as_bam,
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/vcf_realignment/preprocessing/markduplicates/${meta.id}/" },
                pattern: "*{cram,crai}"
            ],
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/reports/vcf_realignment/markduplicates/${meta.id}/" },
                pattern: "*metrics"
            ]
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:GATK4_SPLITNCIGARREADS' {
        // Publish realignment SPLITNCIGARREADS to vcf_realignment directory
        ext.args   = '--create-output-bam-index false'
        ext.prefix = { meta.num_intervals <= 1 ? "${meta.id}.sncr.cram" : "${meta.id}_${intervals.simpleName}.sncr.cram" }
        publishDir = [
            enabled: !params.save_output_as_bam,
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/preprocessing/splitncigarreads/${meta.id}/" },
            pattern: "*{cram,crai}"
        ]
    }

    // Override MERGE_CRAM for realignment workflow to publish to vcf_realignment
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BAM_SPLITNCIGARREADS:CRAM_MERGE_INDEX_SAMTOOLS:MERGE_CRAM' {
        ext.prefix = { "${meta.id}.sncr" }
        ext.when   = { meta.num_intervals > 1 }
        publishDir = [
            enabled: !params.save_output_as_bam,
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/preprocessing/splitncigarreads/${meta.id}/" },
            pattern: "*cram"
        ]
    }

    // Override INDEX_CRAM for realignment workflow to publish to vcf_realignment
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BAM_SPLITNCIGARREADS:CRAM_MERGE_INDEX_SAMTOOLS:INDEX_CRAM' {
        ext.args = params.bam_csi_index ? '-c' : ''
        publishDir = [
            enabled: !params.save_output_as_bam,
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/preprocessing/splitncigarreads/${meta.id}/" },
            pattern: "*{cram,crai}"
        ]
    }

    // ============================================================================
    // Variant Calling
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BCFTOOLS_MPILEUP' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/bcftools/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MUTECT2_PAIRED' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/mutect2/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi,stats}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MERGE_MUTECT2.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/mutect2/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:STRELKA_.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/strelka/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MERGE_STRELKA.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/strelka/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:DEEPSOMATIC' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/deepsomatic/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MERGE_DEEPSOMATIC.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/deepsomatic/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Normalization (VT decompose + BCFTools norm)
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:VT_DECOMPOSE' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/normalized/${meta.variantcaller}/${meta.id}/" },
            pattern: "*.dec.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BCFTOOLS_NORM' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/normalized/${meta.variantcaller}/${meta.id}/" },
            pattern: "*.norm.{vcf,vcf.gz,vcf.gz.tbi,vcf.gz.csi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Consensus VCF generation
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:VCF_CONSENSUS' {
        ext.prefix = { "${meta.id}" }
        ext.thr = 2
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/consensus/${meta.id}/" },
            pattern: "*consensus.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // VCF Filtering
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:VCF_FILTER' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/filtered/${meta.id}/" },
            pattern: "*filtered*.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:FILTER_RNA_MUTATIONS' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/filtered/${meta.id}/" },
            pattern: "*filtered*.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Second Rescue Workflow - Conditional placement based on realignment
    // ============================================================================
    
    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:VCF_RESCUE' {
        ext.prefix = { "${meta.id}" }
        ext.snv_thr = 2
        ext.indel_thr = 2
        publishDir = [
            mode: params.publish_dir_mode,
            path: { meta.id.contains('_realign') ? "${params.outdir}/vcf_realignment/rescue/${meta.id}/" : "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*rescued.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:RNA_EDITING_ANNOTATION' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { meta.id.contains('_realign') ? "${params.outdir}/vcf_realignment/rescue/${meta.id}/" : "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*rna_annotated.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:COSMIC_GNOMAD_ANNOTATION' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { meta.id.contains('_realign') ? "${params.outdir}/vcf_realignment/rescue/${meta.id}/" : "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*cosmic_gnomad*.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:VCF_RESCUE_FILTER' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { meta.id.contains('_realign') ? "${params.outdir}/vcf_realignment/rescue/${meta.id}/" : "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*filtered*.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Preprocessing/Realignment - VCF2BED and Read ID extraction
    // These processes are called from PREPARE_REALIGNMENT_VCF, NOT RNA_REALIGNMENT_WORKFLOW
    // ============================================================================
    
    // HISAT2 alignment BAM/BAI publishing for realignment
    withName: '.*:PREPARE_REALIGNMENT_VCF:FASTQ_ALIGN_HISAT2:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_SORT' {
        ext.prefix  = { params.split_fastq > 1 ? "${meta.id}".concat('.').concat(bam.name.tokenize('.')[1]).concat('.aligned_hs2') : "${meta.id}.aligned_hs2" }
        publishDir = [
            path: { "${params.outdir}/vcf_realignment/preprocessing/mapped/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.bam",
            saveAs: { params.save_bam_mapped ? it : null }
        ]
    }

    withName: '.*:PREPARE_REALIGNMENT_VCF:FASTQ_ALIGN_HISAT2:BAM_SORT_STATS_SAMTOOLS:SAMTOOLS_INDEX' {
        ext.args   = params.bam_csi_index ? '-c' : ''
        ext.prefix  = { params.split_fastq > 1 ? "${meta.id}".concat('.').concat(bam.name.tokenize('.')[1]).concat('.aligned_hs2') : "${meta.id}.aligned_hs2" }
        publishDir = [
            path: { "${params.outdir}/vcf_realignment/preprocessing/mapped/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{bai}",
            saveAs: { params.save_bam_mapped ? it : null }
        ]
    }
    
    withName: '.*:PREPARE_REALIGNMENT_VCF:VCF2BED' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/vcf2bed/${meta.id}/" },
            pattern: "*.bed",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PREPARE_REALIGNMENT_VCF:SAMTOOLS_EXTRACT_READ_IDS' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/readids/${meta.id}/" },
            pattern: "*.txt",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:PREPARE_REALIGNMENT_VCF:MAF2BED' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/maf2bed/${meta.id}/" },
            pattern: "*.bed",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // FILTERMUTECTCALLS - Enable for realignment with proper output directory
    // ============================================================================
    
    // Match both FILTERMUTECTCALLS and FILTERMUTECTCALLS_REALIGN in realignment workflow
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:FILTERMUTECTCALLS' {
        ext.prefix = { "${meta.id}.mutect2.filtered" }
        // For realignment, run without contamination/segmentation/orientation tables
        ext.args   = { meta.status >= 2 ? '--max-events-in-region 5' : '' }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/mutect2/${meta.id}/" },
            pattern: "*{vcf.gz,vcf.gz.tbi,stats}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:FILTERMUTECTCALLS_REALIGN' {
        ext.prefix = { "${meta.id}.mutect2.filtered" }
        // For realignment, run without contamination/segmentation/orientation tables
        ext.args   = { meta.status >= 2 ? '--max-events-in-region 5' : '' }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/mutect2/${meta.id}/" },
            pattern: "*{vcf.gz,vcf.gz.tbi,stats}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Reports - Keep in reports directory for MultiQC aggregation
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:SAMTOOLS_FLAGSTAT' {
        publishDir = [
            path: { "${params.outdir}/reports/vcf_realignment/samtools/${meta.patient}/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{flagstat,txt}",
            enabled: params.save_align_intermeds
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MOSDEPTH' {
        publishDir = [
            path: { "${params.outdir}/reports/vcf_realignment/mosdepth/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{txt,bed.gz,bed.gz.csi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BCFTOOLS_STATS' {
        publishDir = [
            path: { "${params.outdir}/reports/vcf_realignment/bcftools/${meta.variantcaller}/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{txt,stats}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}
