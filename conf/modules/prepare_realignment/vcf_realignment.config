/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for VCF Realignment Workflow - Comprehensive publishDir overrides
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    This config routes all realignment workflow outputs to vcf_realignment/ directory
    to keep them separate from main pipeline outputs.
    
    Pattern explanation:
    - Uses wildcard selectors: '.*:RNA_REALIGNMENT_WORKFLOW:.*:PROCESS_NAME'
    - This catches processes nested within RNA_REALIGNMENT_WORKFLOW regardless of parent scope
    - Loaded AFTER base modules.config to ensure overrides take precedence
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

process {

    // ============================================================================
    // GATK Preprocessing (already handled by optimization.config)
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:GATK4_MARKDUPLICATES' {
        publishDir = [
            [
                enabled: !params.save_output_as_bam,
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/vcf_realignment/preprocessing/markduplicates/${meta.id}/" },
                pattern: "*{cram,crai}"
            ],
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/reports/vcf_realignment/markduplicates/${meta.id}/" },
                pattern: "*metrics"
            ]
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:GATK4_SPLITNCIGARREADS' {
        publishDir = [
            enabled: !params.save_output_as_bam,
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/preprocessing/splitncigarreads/${meta.id}/" },
            pattern: "*{cram,crai}"
        ]
    }

    // ============================================================================
    // Variant Calling
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BCFTOOLS_MPILEUP' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/bcftools/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MUTECT2_PAIRED' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/mutect2/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi,stats}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MERGE_MUTECT2.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/mutect2/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:STRELKA_.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/strelka/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MERGE_STRELKA.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/strelka/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:DEEPSOMATIC' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/deepsomatic/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MERGE_DEEPSOMATIC.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/deepsomatic/${meta.id}/" },
            pattern: "*{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Normalization (VT decompose + BCFTools norm)
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:VT_DECOMPOSE' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/normalized/${meta.variantcaller}/${meta.id}/" },
            pattern: "*.dec.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BCFTOOLS_NORM' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/normalized/${meta.variantcaller}/${meta.id}/" },
            pattern: "*.norm.{vcf,vcf.gz,vcf.gz.tbi,vcf.gz.csi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Consensus VCF generation
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:VCF_CONSENSUS' {
        ext.prefix = { "${meta.id}" }
        ext.thr = 2
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/consensus/${meta.id}/" },
            pattern: "*consensus.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // VCF Filtering
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:VCF_FILTER' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/filtered/${meta.id}/" },
            pattern: "*filtered*.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:FILTER_RNA_MUTATIONS' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/filtered/${meta.id}/" },
            pattern: "*filtered*.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Second Rescue Workflow - Keep in main rescue/ directory for consistency
    // ============================================================================
    
    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:VCF_RESCUE' {
        ext.prefix = { "${meta.id}" }
        ext.snv_thr = 2
        ext.indel_thr = 2
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*rescued.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:RNA_EDITING_ANNOTATION' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*rna_annotated.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:COSMIC_GNOMAD_ANNOTATION' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*cosmic_gnomad.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:SECOND_RESCUE_WORKFLOW:.*:VCF_RESCUE_FILTER' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/rescue/${meta.id}/" },
            pattern: "*filtered*.{vcf,vcf.gz,vcf.gz.tbi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Preprocessing/Realignment - VCF2BED and Read ID extraction
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:VCF2BED' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/preprocessing/realignment/vcf2bed/${meta.id}/" },
            pattern: "*.bed",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:SAMTOOLS_EXTRACT_READ_IDS' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/preprocessing/realignment/readids/${meta.id}/" },
            pattern: "*.txt",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MAF2BED' {
        ext.prefix = { "${meta.id}" }
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/preprocessing/realignment/maf2bed/${meta.id}/" },
            pattern: "*.bed",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // FILTERMUTECTCALLS - Route realignment filtered outputs to vcf_realignment/
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:FILTERMUTECTCALLS.*' {
        publishDir = [
            mode: params.publish_dir_mode,
            path: { "${params.outdir}/vcf_realignment/variant_calling/mutect2/${meta.id}/" },
            pattern: "*.{vcf,vcf.gz,vcf.gz.tbi,tsv}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    // ============================================================================
    // Reports - Keep in reports directory for MultiQC aggregation
    // ============================================================================
    
    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:SAMTOOLS_FLAGSTAT' {
        publishDir = [
            path: { "${params.outdir}/reports/vcf_realignment/samtools/${meta.patient}/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{flagstat,txt}",
            enabled: params.save_align_intermeds
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:MOSDEPTH' {
        publishDir = [
            path: { "${params.outdir}/reports/vcf_realignment/mosdepth/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{txt,bed.gz,bed.gz.csi}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: '.*:RNA_REALIGNMENT_WORKFLOW:.*:BCFTOOLS_STATS' {
        publishDir = [
            path: { "${params.outdir}/reports/vcf_realignment/bcftools/${meta.variantcaller}/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{txt,stats}",
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}
