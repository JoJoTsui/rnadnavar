/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for VCF Realignment Optimization modules
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

process {

    withName: 'FILE_VALIDATION' {
        publishDir = [
            enabled: false
        ]
    }

    withName: 'VCF_FORMAT_VALIDATION' {
        publishDir = [
            [
                path: { "${params.outdir}/pipeline_info/validation_reports" },
                mode: params.publish_dir_mode,
                pattern: "*.txt"
            ],
            [
                enabled: false,
                pattern: "*.vcf.gz*"
            ]
        ]
    }

    withName: 'SAMTOOLS_CONVERT_ENHANCED' {
        publishDir = [
            enabled: false
        ]
    }

    withName: 'PROCESS_MONITORING' {
        publishDir = [
            path: { "${params.outdir}/pipeline_info/monitoring" },
            mode: params.publish_dir_mode,
            pattern: "*.{txt,log,json}"
        ]
    }

    withName: 'SANITIZE_CHANNELS' {
        publishDir = [
            enabled: false
        ]
    }

    withName: 'SAFE_CHANNEL_JOIN' {
        publishDir = [
            enabled: false
        ]
    }
    
    withName: 'ENHANCED_CRAM2BAM_CONVERSION' {
        publishDir = [
            enabled: false
        ]
    }
    
    withName: 'INPUT_VALIDATION' {
        publishDir = [
            enabled: false
        ]
    }

    withName: '.*:PREPARE_REALIGNMENT_VCF:.*:SAMTOOLS_SORT' {
        publishDir = [
            path: { "${params.outdir}/vcf_realignment/preprocessing/hisat2/${meta.patient}/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.bam",
            enabled: params.save_align_intermeds
        ]
    }

    withName: '.*:PREPARE_REALIGNMENT_VCF:.*:SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/vcf_realignment/preprocessing/hisat2/${meta.patient}/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{bai,csi}",
            enabled: params.save_align_intermeds
        ]
    }

    // Override for all SAMTOOLS_FLAGSTAT to prevent leaking into samtools/ directory
    // This covers both the realignment workflow and the main alignment workflow
    withName: '.*:SAMTOOLS_FLAGSTAT' {
        publishDir = [
            path: { "${params.outdir}/reports/vcf_realignment/samtools/${meta.patient}/${meta.id}/" },
            mode: params.publish_dir_mode,
            pattern: "*.{flagstat,txt}",
            enabled: params.save_align_intermeds
        ]
    }
}
