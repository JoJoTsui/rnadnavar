/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
        ext.when   = When to run the module.
----------------------------------------------------------------------------------------
*/

// ANNOTATE

process {  // annotate

    // VEP
    withName: 'ENSEMBLVEP_VEP' {
        ext.args         = { [
            (params.vep_dbnsfp && params.dbnsfp && !params.dbnsfp_consequence)    ? "--plugin dbNSFP,${params.dbnsfp.split("/")[-1]},${params.dbnsfp_fields}"                                              : '',
            (params.vep_dbnsfp && params.dbnsfp && params.dbnsfp_consequence)     ? "--plugin dbNSFP,'consequence=${params.dbnsfp_consequence}',${params.dbnsfp.split("/")[-1]},${params.dbnsfp_fields}"   : '',
            (params.vep_loftee)                                                   ? "--plugin LoF,loftee_path:/opt/conda/envs/nf-core-vep-${params.vep_version}/share/ensembl-vep-${params.vep_version}-0" : '',
            (params.vep_spliceai && params.spliceai_snv && params.spliceai_indel) ? "--plugin SpliceAI,snv=${params.spliceai_snv.split("/")[-1]},indel=${params.spliceai_indel.split("/")[-1]}"            : '',
            (params.vep_spliceregion)                                             ? "--plugin SpliceRegion"                                                                                                : '',
            (params.vep_out_format)                                               ? "--${params.vep_out_format}"                                                                                           : '--vcf',
            (params.vep_custom_args)                                              ?: ""
        ].join(' ').trim() }
        // If just VEP: <vcf prefix>_VEP.ann.vcf
        ext.prefix       = { "${meta.id}.${meta.variantcaller}.variants.dec.norm_VEP.ann" }
        publishDir       = [
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/reports/EnsemblVEP/${meta.variantcaller}/${meta.id}/" },
                pattern: "*html"
            ],
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/annotation/${meta.variantcaller}/${meta.id}/" },
                pattern: "*{gz}"
            ]
        ]
    }

    withName: ".*:VCF_ANNOTATE:.*:(TABIX_BGZIPTABIX|TABIX_TABIX)" {
        ext.prefix       = { input.name - ".vcf" }
        publishDir       = [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/annotation/${meta.variantcaller}/${meta.id}/" },
                pattern: "*{gz.tbi}"
        ]
    }

    // RNA EDITING ANNOTATION with comprehensive logging and monitoring
    withName: 'RNA_EDITING_ANNOTATION' {
        ext.args         = { 
            [
                params.rna_annotation_args ?: '',
                params.rna_annotation_verbose ? '--verbose' : ''
            ].join(' ').trim()
        }
        ext.prefix       = { "${meta.id}.rescue.rna_annotated" }
        ext.when         = { params.enable_rna_annotation && params.tools && params.tools.split(',').contains('rescue') }
        
        // Comprehensive publishing for outputs and logs
        publishDir       = [
            // Main output files
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/annotation/rna_editing/${meta.id}/" },
                pattern: "*{vcf.gz,vcf.gz.tbi}",
                saveAs: { filename -> filename }
            ],
            // Log files for operational monitoring
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/logs/rna_editing/${meta.id}/" },
                pattern: "*{.log,.json}",
                saveAs: { filename -> 
                    if (filename.endsWith('.log')) {
                        return "rna_editing_process.log"
                    } else if (filename.contains('metrics') && filename.endsWith('.json')) {
                        return "rna_editing_metrics.json"
                    } else if (filename.contains('stats') && filename.endsWith('.log')) {
                        return "rna_editing_statistics.log"
                    }
                    return filename
                }
            ],
            // Performance and monitoring data
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/reports/rna_editing/${meta.id}/" },
                pattern: "*{metrics*.json,stats*.log}",
                enabled: params.rna_annotation_save_reports ?: false
            ]
        ]
        
        // Environment variables for logging configuration
        ext.env          = [
            'RNA_EDITING_LOG_LEVEL': params.rna_annotation_log_level ?: 'INFO',
            'RNA_EDITING_ENABLE_METRICS': params.rna_annotation_enable_metrics ?: 'true',
            'RNA_EDITING_ENABLE_PERFORMANCE': params.rna_annotation_enable_performance ?: 'true'
        ]
    }

    // COSMIC/gnomAD ANNOTATION with comprehensive configuration and monitoring
    withName: 'COSMIC_GNOMAD_ANNOTATION' {
        ext.args         = { 
            [
                params.cosmic_gnomad_args ?: '',
                params.cosmic_gnomad_verbose ? '--verbose' : '',
                params.cosmic_gnomad_germline_freq_threshold ? "--germline-freq-threshold ${params.cosmic_gnomad_germline_freq_threshold}" : '',
                params.cosmic_gnomad_somatic_consensus_threshold ? "--somatic-consensus-threshold ${params.cosmic_gnomad_somatic_consensus_threshold}" : '',
                params.cosmic_gnomad_cosmic_recurrence_threshold ? "--cosmic-recurrence-threshold ${params.cosmic_gnomad_cosmic_recurrence_threshold}" : '',
                params.cosmic_gnomad_workers ? "--workers ${params.cosmic_gnomad_workers}" : ''
            ].join(' ').trim()
        }
        ext.prefix       = { "${meta.id}.rescue.cosmic_gnomad_annotated" }
        ext.when         = { params.enable_cosmic_gnomad_annotation && params.tools && params.tools.split(',').contains('rescue') }
        
        // Comprehensive publishing for outputs and logs
        publishDir       = [
            // Main output files
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/annotation/cosmic_gnomad/${meta.id}/" },
                pattern: "*{vcf.gz,vcf.gz.tbi}",
                saveAs: { filename -> filename }
            ],
            // Statistics and metrics files
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/reports/cosmic_gnomad/${meta.id}/" },
                pattern: "*_stats.json",
                enabled: params.cosmic_gnomad_save_stats ?: false
            ],
            // Log files for operational monitoring
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/logs/cosmic_gnomad/${meta.id}/" },
                pattern: "*{.log,.json}",
                saveAs: { filename -> 
                    if (filename.endsWith('.log')) {
                        return "cosmic_gnomad_process.log"
                    } else if (filename.contains('metrics') && filename.endsWith('.json')) {
                        return "cosmic_gnomad_metrics.json"
                    } else if (filename.contains('stats') && filename.endsWith('.json')) {
                        return "cosmic_gnomad_statistics.json"
                    }
                    return filename
                }
            ]
        ]
        
        // Resource management for annotation process
        memory           = '24.GB'
        cpus             = 12
        time             = '2.h'
        
        // Error handling strategy
        errorStrategy    = 'retry'
        maxRetries       = 2
        
        // Environment variables for configuration
        ext.env          = [
            'COSMIC_GNOMAD_LOG_LEVEL': params.cosmic_gnomad_log_level ?: 'INFO',
            'COSMIC_GNOMAD_ENABLE_METRICS': params.cosmic_gnomad_enable_metrics ?: 'true'
        ]
    }

}
